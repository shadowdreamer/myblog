---
title: 重构了一下oppo商城那个项目的部分代码
categories:
  - 工作
tags:
  - web
---

# 楔子

事情是这样的，这个问题在独臂哥跑路之后我看代码就发现了，就是商详页面，根据一些参数改变结算价格，参数不多，主要就购买的服务——碎屏保啥的，加购——就是搭配买更《实惠》那种，就这三个会导致价格变动的参数，然后这哥们写法着实牛逼。

# 令人惊叹的算法

只能说是组件化思想很牛逼，首先在父页面定了一个total字段赋值为0，然后这个total字段在商详信息请求得到后复制一个初始价格，到此位置都还是基本操作。

牛逼的是把total传到商品服务的组件和加购的组件，还弄了一个牛逼的vue修饰符`.sync`，这个修饰符能狗同步父子组件的传值，点了服务或者加购后就往total+=price,取消了咋办呢，当然是-price，换了个服务咋办呢？减到原来的，加上现在的，加购也是如此这般。然后问题来了，会有数量变化啊！ 解决方法自然就是把数量再传进组件，服务选项有变化的时候就total+=price*quantity! 妙啊！ 要是数量少了呢， 直接total/=quantity! 这算法性能没谁了吧。

最志希的还在下面，提交订单或者加入购物车需要把加购和服务等等信息转为json字符串后传给后端，这个简单，父组件定一个字段也传给子组件，然后子组件点一下，给json字符串更新一下呗！ 完美！

# 初见

当时独臂哥走人之后，oppo那边组织人代码评审，说实话oppo那边的前端也不算思路转的太快，也许也是加班加累了，我提前几个小时看了下代码，就发现商详这块代码水很深，我避重就轻，完全没提总价逻辑，就说块是商品服务的组件，这块是加购组件blabla。。。。，然后他妈也没说啥。

# bug地狱

这哥们写vue，极爱使用watch，什么都在watch里面，数量变化触发watch，然后给total 加商品价格，或者给total除以quantity。 正常人算应该是（商品价格+加购物品价格+服务价格）*数量，这个逻辑怎么算的我已经理不清了。

最后这代码居然就这么上线了，然后几个月后终于有人提这个bug了。大概因为商详价格仅展示，然后也没人一下子会买好几个手机。

# 解决方法

终于要我来改这个bug，没办法，逃不掉，只能重构了，其实也很简单total用一个计算属性就完事了，搞不懂这一万个watch是什么脑回路写出来的。

顺带一提这几个月改的oppo商城的bug全是独臂哥部分，可以算是《人类高质量代码图鉴》了。

累了，快点给钱吧！